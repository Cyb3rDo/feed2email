#!/usr/bin/env ruby

require 'digest/md5'
require 'yaml'

CONFIG_DIR = File.expand_path('~/.feed2email')
HISTORY_FILE = File.join(CONFIG_DIR, 'history.yml')

if !File.exist?(HISTORY_FILE)
  $stderr.puts "Missing history file #{HISTORY_FILE}"
  exit 1
end

history_data = YAML.load(open(HISTORY_FILE))

if !history_data.is_a?(Hash)
  $stderr.puts "Invalid data type for history file #{HISTORY_FILE}"
  exit 2
end

history_data.each do |feed_uri, entries|
  hist_filename = "history-#{Digest::MD5.hexdigest(feed_uri)}.yml"
  hist_path = File.join(CONFIG_DIR, hist_filename)
  open(hist_path, 'w') {|f| f.write(entries.to_yaml) }
  puts "Extracted history of #{feed_uri} to #{hist_filename}"
end

File.rename(HISTORY_FILE, "#{HISTORY_FILE}.bak")
puts "Renamed #{HISTORY_FILE} to #{HISTORY_FILE}.bak"
