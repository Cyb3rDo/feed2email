#!/usr/bin/env ruby

require 'yaml'

CONFIG_DIR = File.expand_path('~/.feed2email')
FEEDS_FILE = File.join(CONFIG_DIR, 'feeds.yml')

if !File.exist?(FEEDS_FILE)
  $stderr.puts "Missing feed list file #{FEEDS_FILE}"
  exit 1
end

feeds_data = YAML.load(open(FEEDS_FILE))

unless feeds_data.is_a?(Array) && feeds_data.all? {|data| data.is_a?(String) }
  $stderr.puts "Invalid data type for feed list file #{FEEDS_FILE}"
  exit 2
end

File.rename(FEEDS_FILE, "#{FEEDS_FILE}.bak")

begin
  open(FEEDS_FILE, 'w') do |f|
    f.write(
      feeds_data.map {|uri|
        { uri: uri, enabled: true }
      }.to_yaml
    )
  end

  puts "Migrated feed list file #{FEEDS_FILE}"
  puts "Renamed #{FEEDS_FILE} to #{FEEDS_FILE}.bak"
rescue
  File.rename("#{FEEDS_FILE}.bak", FEEDS_FILE)
  raise
end
